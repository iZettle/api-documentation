Fetch purchase information for card transactions
===
Using the Finance API and the Purchase API, you can fetch purchase information for transactions that are made with a Zettle card reader.

* [Prerequisites](#prerequisites)
* [Step 1: Find the card transaction UUID](#step-1-find-the-card-transaction-uuid)
* [Step 2: Fetch purchase information for card transactions](#step-2-fetch-purchase-information-for-card-transactions)
* [Related task](#related-task)
* [Related API reference](#related-api-reference)

## Prerequisites
* Make sure that authorization is set up using [Authorization OAuth2 API](../../authorization.adoc). 
<!-- to be continued if any -->

## Step 1: Find the card transaction UUID
Find the transaction UUID for card transactions for which you will fetch purchase information.  

1. Optional: Fetch your organisation UUID. 
> **Tip:** You don't need to fetch the organisation UUID, as you can specify the organisation UUID as `self` in requests that require it.

   ```
   GET users/me
   ```
   Example:
       
   The following example returns organisation UUID `ab305d54-75b4-431b-adb2-eb6b9e546013`.

   ```
   {
        "uuid": "de305d54-75b4-431b-adb2-eb6b9e546014",
        "organizationUuid": "ab305d54-75b4-431b-adb2-eb6b9e546013"
   }
   ```
       
2. Fetch the account card transactions.
> **Tip:** You specify the organisation UUID as `self`.

   ```
   GET /organizations/{organizationUuid}/accounts/{accountTypeGroup}/transactions?{start}&{end}&includeTransactionType=CARD_PAYMENT
   ```
   Example:
       
   The following example returns `originatingTransactionUuid` as `336a4946-4528-11eb-8078-fdfb2cfbeb76`.

   ```json
   {
       "data": [
           {
               "timestamp": "2020-12-23T14:15:23.335+0000",
               "amount": -200,
               "originatorTransactionType": "CARD_PAYMENT",
               "originatingTransactionUuid": "336a4946-4528-11eb-8078-fdfb2cfbeb76"
           },
           {
               "timestamp": "2020-12-23T14:07:34.720+0000",
               "amount": 200,
               "originatorTransactionType": "CARD_PAYMENT",
               "originatingTransactionUuid": "336a4946-4528-11eb-8078-fdfb2cfbeb76"
           },
           ...
       ]
   ```

3. In the response, find and save the value of `originatingTransactionUuid` for transactions for which you want to fetch purchase information. This is the key used to sign all requests and should be stored so that you can validate the request.

## Step 2: Fetch purchase information for card transactions
You can subscribe to one or more events in one subscription request.

1. Fetch purchase information for the card transactions. In the request body, `purchaseUuid` is the value of `originatingTransactionUuid` that you saved in [Step 1: Find the transaction UUID of a card payment](#step-1-find-the-transaction-uuid-of-a-card-payment).
    
    ```
    GET /purchase/v2/{purchaseUuid}
    ```
      
    Example:
    
    The following example request fetches purchase information for `originatingTransactionUuid` as `336a4946-4528-11eb-8078-fdfb2cfbeb76`.
    ```
    GET /purchase/v2/336a4946-4528-11eb-8078-fdfb2cfbeb76
    ```
    The following example response returns purchase information for `originatingTransactionUuid` as `336a4946-4528-11eb-8078-fdfb2cfbeb76`.
    
    ```json
    {
        "purchases": [
            {
                "source": "POS",
                "purchaseUUID": "3XsSIGpIEeiFm5q12ABncw",
                "amount": 2920,
                "vatAmount": 214,
                "taxAmount": 214,
                "country": "GB",
                "currency": "GBP",
                "timestamp": "2018-06-07T11:49:42.082+0000",
                "purchaseNumber": 7140,
                "userDisplayName": "Gary Mackenzie",
                "userId": 5001432,
                "organizationId": 6114307,
                "products": [
                    {
                        "quantity": "1",
                        "productUuid": "d9d48650-3dbc-11e8-a8a2-755d6719203e",
                        "variantUuid": "d9d45f40-3dbc-11e8-9a99-01b7a445662e",
                        "vatPercentage": 20.0,
                        "taxRates": [
                            {
                                "percentage": 20.0
                            }
                        ],
                        "taxExempt": false,
                        "unitPrice": 150,
                        "rowTaxableAmount": 125,
                        "name": "Tray Bake",
                        "variantName": "Tray Bake 1",
                        "autoGenerated": false,
                        "id": "d9d45f40-3dbc-11e8-9a99-01b7a445662e_150",
                        "type": "PRODUCT",
                        "grossValue": 150,
                        "grossTax": 25,
                        "libraryProduct": true
                    },
                ...
               "discounts": [],
               "payments": [
                   {
                       "uuid": "dd7b1220-6a48-11e8-849a-9bb4d9016672",
                       "amount": 2920,
                       "type": "IZETTLE_INVOICE",
                       "attributes": {
                           "orderUUID": "dd71505a-6a48-11e8-b047-f70e60a9a038",
                           "invoiceNr": "iz355",
                           "dueDate": "2018-07-07"
                       }
                   }
               ],
               "refundedByPurchaseUUIDs": [
                   "2QXg37F9EeuCuzZoMrMH8g"
               ],
               "receiptCopyAllowed": true,
               "taxationMode": "INCLUSIVE",
               "taxationType": "VAT",
               "taxValues": [
                   {
                       "label": null,
                       "taxValue": 5.0,
                       "taxAmount": 110,
                       "totalAmount": 2300,
                       "taxableAmount": 2190
                   },
                   {
                       "label": null,
                       "taxValue": 20.0,
                       "taxAmount": 104,
                       "totalAmount": 620,
                       "taxableAmount": 516
                   }
               ],
               "created": "2018-06-07T11:49:42.082+0000",
               "refunded": true,
               "purchaseUUID1": "dd7b1220-6a48-11e8-859b-9ab5d8006773",
               "refundedByPurchaseUUIDs1": [
                   "d905e0df-b17d-11eb-82bb-366832b307f2"
               ],
               "groupedVatAmounts": {
                   "5.0": 2300,
                   "20.0": 620
               },
               "refund": false
           },
        ...
       "firstPurchaseHash": "15283721820823XsSIGpIEeiFm5q12ABncw",
       "lastPurchaseHash": "1552911865717xLa1Skl4EemAuk9rTWeWPw",
       "linkUrls": [
           "<https://purchase.izettle.com/purchases/v2?limit=1000&descending=false&lastPurchaseHash=1552911865717xLa1Skl4EemAuk9rTWeWPw>; rel=\"next\""
       ]
   }
    ```

## Related task
* [Fetch a purchase](../../purchase.adoc#fetch-a-purchase)

## Related API reference
* [Finance API reference](../api-reference.md)
* [Purchase API reference](../../purchase.adoc)
<!-- Add more references if needed. -->